#!/usr/bin/env python
from subprocess import call, Popen, PIPE, STDOUT
import onetimepass as otp
from os.path import expanduser
import json
import os
import sys

def clear():
	Popen(["clear"])

def allow():
	print 'Token Accepted'
	# exit with true
	sys.exit(0)

def deny():
	print 'Token Denied'
	# Logout user
	os.kill(os.getppid(), 9)
	# exit with error
	sys.exit(1)

try:
	#get users home directory
	home = expanduser("~")
	#get users token config file path
	tokenfile = home + "/.ssh/authorized_tokens"
	#open and read the token file
	f = open(tokenfile, 'r') # file contents needs to be in following format: {"secrets":["secretkey"]}
	rawTokens = f.read()
	f.close()
	#interpret read file
	tokens = json.loads(rawTokens)
	# check validity for each of the secrets they have
	allowed = False
	for secret in tokens["secrets"]:
		if otp.valid_totp(token=raw_input('~>'), secret=secret, token_length=8):
			allowed = True
	if allowed:
		allow()
	#allow if no secrets for user
	elif len(tokens["secrets"]) == 0:
		allow()
	else:
		deny()
except KeyboardInterrupt:
	# prevent user keyboard interrupt reporting debug data.
	deny()
except Exception,e:
	deny()

# default deny
deny()
